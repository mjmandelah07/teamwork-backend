const express = require("express");
const bcrypt = require("bcrypt");
const db = require("../db/db");

const router = express.Router();

// Middleware to handle database connection
const withDBConnection = (handler) => async (req, res, next) => {
  const client = await db.connect();
  try {
    await handler(req, res, next, client);
  } catch (error) {
    console.error("Error:", error);
    res.status(500).json({ error: "An error occurred" });
  } finally {
    db.end();
  }
};

// Get all users
router.get("/", withDBConnection(async (req, res, client) => {
  const result = await db.query("SELECT * FROM allUsers");
  res.send(result.rows);
}));

// Create a new user
router.post("/", withDBConnection(async (req, res, client) => {
  const userData = req.body;
  const hashedPassword = await bcrypt.hash(userData.password, 10);
  const insertUserDataQuery = `
    INSERT INTO allUsers (
      firstName, lastName, email, password, gender, job_role, department, address, role, created_on
    ) VALUES (
      $1, $2, $3, $4, $5, $6, $7, $8, $9, $10
    );
  `;
  const values = [
    userData.firstName,
    userData.lastName,
    userData.email,
    hashedPassword,
    userData.gender,
    userData.job_role,
    userData.department,
    userData.address,
    userData.role,
    new Date(),
  ];

  await db.query(insertUserDataQuery, values);
  res.json({ message: "User created successfully" });
}));

module.exports = router;
